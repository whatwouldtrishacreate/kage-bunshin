name: Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: [self-hosted, docker, build]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check Python version
      run: |
        python3 --version

    - name: Set up virtual environment
      run: |
        python3 -m venv venv
        source venv/bin/activate
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests before deployment
      run: |
        source venv/bin/activate
        pytest tests/ -v --tb=short
      env:
        PYTHONPATH: .

    - name: Deploy to production server
      run: |
        # SSH to main server and deploy
        ssh -o StrictHostKeyChecking=no ndninja@100.77.248.9 << 'EOF'
          cd /home/ndninja/projects/kage-bunshin || exit 1

          # Pull latest changes
          git fetch origin
          git reset --hard origin/master

          # Install/update dependencies
          source venv/bin/activate || python3 -m venv venv && source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # Run database migrations if any
          if [ -d "migrations" ]; then
            python -m migrations.migrate || echo "No migrations to run"
          fi

          # Restart the service
          if pgrep -f "uvicorn api.main:app" > /dev/null; then
            pkill -f "uvicorn api.main:app"
            sleep 2
          fi

          # Start the service in background
          nohup python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 >> /home/ndninja/logs/kage-bunshin.log 2>&1 &

          # Wait and verify it started
          sleep 3
          if pgrep -f "uvicorn api.main:app" > /dev/null; then
            echo "‚úÖ Kage Bunshin deployed and running on http://100.77.248.9:8000"
          else
            echo "‚ùå Deployment failed - service not running"
            exit 1
          fi
        EOF

    - name: Health check
      run: |
        # Wait for service to be fully ready
        sleep 5

        # Check if the API is responding
        response=$(curl -s -o /dev/null -w "%{http_code}" http://100.77.248.9:8000/health || echo "000")

        if [ "$response" = "200" ]; then
          echo "‚úÖ Health check passed - API is responding"
        else
          echo "‚ö†Ô∏è Health check failed - got HTTP $response"
          echo "Service may still be starting up..."
        fi

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "üöÄ Deployment successful!"
          echo "üìç Server: http://100.77.248.9:8000"
        else
          echo "‚ùå Deployment failed!"
        fi
