name: Runner Test

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/runner-test.yml'

jobs:
  test-runner1:
    name: Test Runner 1 (Build)
    runs-on: [self-hosted, docker, build]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: System Information
      run: |
        echo "=== System Information ==="
        uname -a
        echo ""
        echo "=== Hostname ==="
        hostname
        echo ""
        echo "=== Python Version ==="
        python3 --version
        echo ""
        echo "=== Docker Version ==="
        docker --version
        echo ""
        echo "=== Git Version ==="
        git --version
        echo ""
        echo "=== Disk Space ==="
        df -h
        echo ""
        echo "=== Memory ==="
        free -h

    - name: Test Docker
      run: |
        echo "Testing Docker functionality..."
        docker run --rm hello-world

    - name: Test Python Virtual Environment
      run: |
        echo "Creating Python virtual environment..."
        python3 -m venv test-venv
        source test-venv/bin/activate
        pip install --upgrade pip
        pip install requests pytest
        echo "Python packages installed successfully"
        deactivate
        rm -rf test-venv

    - name: Test Git Operations
      run: |
        echo "Testing Git operations..."
        git status
        git log -1 --oneline
        echo "Git operations successful"

    - name: Runner Info
      run: |
        echo "=== Runner Information ==="
        echo "Runner name: $RUNNER_NAME"
        echo "Runner OS: $RUNNER_OS"
        echo "Runner temp: $RUNNER_TEMP"
        echo "Runner workspace: $RUNNER_WORKSPACE"

  test-runner2:
    name: Test Runner 2 (Test)
    runs-on: [self-hosted, docker, test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: System Information
      run: |
        echo "=== System Information ==="
        uname -a
        echo ""
        echo "=== Hostname ==="
        hostname
        echo ""
        echo "=== Python Version ==="
        python3 --version
        echo ""
        echo "=== Docker Version ==="
        docker --version
        echo ""
        echo "=== Git Version ==="
        git --version

    - name: Test Docker
      run: |
        echo "Testing Docker functionality..."
        docker run --rm hello-world

    - name: Run Sample Test
      run: |
        echo "Creating sample test..."
        python3 -m venv test-venv
        source test-venv/bin/activate
        pip install pytest
        mkdir -p test-temp
        cat > test-temp/test_sample.py << 'EOF'
def test_addition():
    assert 1 + 1 == 2

def test_string():
    assert "hello" + " world" == "hello world"
EOF
        pytest test-temp/test_sample.py -v
        deactivate
        rm -rf test-venv test-temp

    - name: Runner Info
      run: |
        echo "=== Runner Information ==="
        echo "Runner name: $RUNNER_NAME"
        echo "Runner OS: $RUNNER_OS"
        echo "Runner temp: $RUNNER_TEMP"
        echo "Runner workspace: $RUNNER_WORKSPACE"

  parallel-test:
    name: Test Parallel Execution
    needs: [test-runner1, test-runner2]
    runs-on: [self-hosted, docker, build]

    steps:
    - name: Parallel Test Complete
      run: |
        echo "âœ… Both runners completed successfully!"
        echo "âœ… Runner 1 (build labels) - PASSED"
        echo "âœ… Runner 2 (test labels) - PASSED"
        echo "âœ… Parallel execution - VERIFIED"
        echo ""
        echo "ðŸŽ‰ Self-hosted GitHub Actions runners on ndnlinuxsrv2 are fully operational!"
